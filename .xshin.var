#!/data/data/com.termux/files/usr/bin/env bash

# Author : xShin
# GitHub : https://github.com/xshin404

# Variable Color
df="\e[39m"
wh="\e[97m"
rd="\e[31m"
gn="\e[32m"
yw="\e[33m"
bl="\e[34m"
mg="\e[35m"
cyn="\e[36m"
lgy="\e[37m"
dgy="\e[90m"
lrd="\e[91m"
lgn="\e[92m"
lyw="\e[93m"
lbl="\e[94m"
lmg="\e[95m"
lcyn="\e[96m"

DIR=`cd $(dirname $0); pwd`

function banner() {

    echo -e "\n$blâ•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"
    echo -e "â•‘              $df$lrd _______$bl                                  â•‘"
    echo -e "â•‘              $df$lrd(_______)$bl                                 â•‘"
    echo -e "â•‘     $df$wh ____  _   _$lrd _\e[97m _____  ____ ____  _   _ _   _$bl       â•‘"
    echo -e "â•‘     $df$wh|    \| | | $lrd| |\e[97m ___ |/ ___)    \| | | ( \ / )$bl      â•‘"
    echo -e "â•‘     $df$wh| | | | |_| $lrd| |\e[97m ____| |   | | | | |_| |) X ($bl       â•‘"
    echo -e "â•‘     $df$wh|_|_|_|\__  $lrd|_|\e[97m_____)_|   |_|_|_|____/(_/ \_)$bl      â•‘"
    echo -e "â•‘           $df$wh(____/$bl                                       â•‘"
    echo -e "â•‘                                                        â•‘"
    echo -e "â•‘             ğŸš€$wh Version         :$lyw 0.4.1 pre $bl            â•‘"
    echo -e "â•‘             ğŸ“…$wh Build Date      :$lrd 23 March 2021 $bl        â•‘"
    echo -e "â•‘             ğŸ“¦$wh Repository Size :$lgn $repoSize $bl             â•‘"
    echo -e "â•‘             âš™ï¸ $wh Maintainer      :$mg xShin$df$bl                 â•‘"
    echo -e "â•‘                                                        â•‘"
    echo -e "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯$df"
    echo -e "              âš ï¸ $wh Mode            :$lgn $mode\n$df"

}

function reposize() {
    if [ "$#" -eq 2 ]; then
        echo "$(echo "scale=2
        $(curl https://api.github.com/repos/$1/$2 2>/dev/null | grep size | head -1 | tr -dc '[:digit:]') / 1024" | bc) MB"
    fi
}
repoSize=`reposize xshin404 myTermux`

# Backups
backups=( 
    ".termux"  
    ".config"
    ".scripts"
    ".oh-my-zsh"
    ".zshrc"
)

backup() {

    echo -e "âš™ï¸ Backup dotfiles"

    for backup in "${backups[@]}"; do

        start_spinner_backup "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ $backup"
        sleep 2

        if [[ -f $HOME/$backup || -d $HOME/$backup ]]; then

            mv -u ${HOME}/${backup}{,.$(date +%Y.%m.%d-%H.%M.%S)};
            stop_spinner_backup $?
            echo -e " â€â€â€â€ âš ï¸ backup to $backup.$(date +%Y.%m.%d-%H.%M.%S)\n"

        else

            sleep 2
            cp "empty" > /dev/null 2>&1
            stop_spinner_backup $?

        fi

    done

}

# Lightweight Installation
lightweightpkgs=(

    "git"
    "curl"
    "zsh"
    "neofetch"
    "exa"
    "lf"
    "bat"
    "mpd" 
    "ncmpcpp"
    "neovim"

)

function lightweightpackage() {

    echo -e "\nâš™ï¸ Installing lightweight package\n"

    cp -R $DIR/.scripts $HOME/.scripts &>/dev/null

    if [[ -f $HOME/.scripts/list-packages.sh ]]; then

        bash $HOME/.scripts/list-packages.sh table lightweight

    fi

    echo ""

    for lightweightpkg in "${lightweightpkgs[@]}"; do

        start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ $lightweightpkg"
        pkg install -y $lightweightpkg &>/dev/null

        check() {

            ipkg=$(pkg list-installed $lightweightpkg 2> /dev/null | tail -n 1)
            cpkg=${ipkg%/*}

            if [[ $cpkg == $lightweightpkg ]]; then

                stop_spinner $? || exit 1;

            else

                sleep 2
                cp "empty" > /dev/null 2>&1
                stop_spinner $?
                start_spinner "â€â€â€â€â€â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ â€$lightweightpkg (retrying) â€â€â€â€ "
                pkg install -y $lightweightpkg &>/dev/null
                check
            
            fi

        }

        check

    done

}

# Full Installation
fullpkgs=(

    "git"
    "curl"
    "zsh"
    "neofetch"
    "exa"
    "lf"
    "bat"
    "mpd" 
    "ncmpcpp"
    "neovim"
    "nodejs"

)

function fullpackage() {

    echo -e "\nâš™ï¸ Installing full package\n"

    cp -R $DIR/.scripts $HOME/.scripts &>/dev/null

    if [[ -f $HOME/.scripts/list-packages.sh ]]; then

        bash $HOME/.scripts/list-packages.sh table full

    fi

    echo ""

    for fullpkg in "${fullpkgs[@]}"; do

        start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ $fullpkg"
        pkg install -y $fullpkg &>/dev/null

        check() {

            ipkg=$(pkg list-installed $fullpkg 2> /dev/null | tail -n 1)
            cpkg=${ipkg%/*}

            if [[ $cpkg == $fullpkg ]]; then

                stop_spinner $? || exit 1;
                        
            else

                sleep 2
                cp "empty" > /dev/null 2>&1
                stop_spinner $?
                start_spinner "â€â€â€â€â€â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ â€$fullpkg (retrying) â€â€â€â€ "
                pkg install -y $fullpkg &>/dev/null
                check

            fi

        }

        check

    done

}

function zshrepo() {

    echo -e "\nâš™ï¸ Installing oh-my-zsh"

    function ohmyzsh() {

        start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ oh-my-zsh"
        git clone git://github.com/robbyrussell/oh-my-zsh.git $HOME/.oh-my-zsh/ &>/dev/null
    
        check() {

            if [[ -d $HOME/.oh-my-zsh ]]; then

                stop_spinner $?

            else

                cp "empty" > /dev/null 2>&1
                stop_spinner $?
                start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ oh-my-zsh (retrying)"
                git clone git://github.com/robbyrussell/oh-my-zsh.git $HOME/.oh-my-zsh/ &>/dev/null
                check

            fi

        }

        check

    }

    ohmyzsh

    echo -e "\nâš™ï¸ Installing plugin oh-my-zsh"

    function highlighting() {

        start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ zsh-syntax-highlighting"
        git clone git://github.com/zsh-users/zsh-syntax-highlighting.git $HOME/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting &>/dev/null

        check() {

            if [[ -d $HOME/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting ]]; then

                stop_spinner $?

            else

                cp "empty" > /dev/null 2>&1
                stop_spinner $?
                start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ zsh-syntax-highlighting (retrying)"
                git clone git://github.com/zsh-users/zsh-syntax-highlighting.git $HOME/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting &>/dev/null
                check

            fi

        }

        check

    }

    highlighting

    function autosuggest() {

        start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ zsh-autosuggestions"
        git clone git://github.com/zsh-users/zsh-autosuggestions.git $HOME/.oh-my-zsh/custom/plugins/zsh-autosuggestions &>/dev/null

        check() {

            if [[ -d $HOME/.oh-my-zsh/custom/plugins/zsh-autosuggestions ]]; then

                stop_spinner $?

            else

                cp "empty" > /dev/null 2>&1
                stop_spinner $?
                start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ zsh-autosuggestions (retrying)"
                git clone git://github.com/zsh-users/zsh-autosuggestions.git $HOME/.oh-my-zsh/custom/plugins/zsh-autosuggestions &>/dev/null
                check

            fi

        }

        check

    }

    autosuggest

}

function shell() {

    echo -e "\nâš™ï¸ Setting SHELL default"

        zsh() {

            start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ change shell to zsh"
            sleep 2

            check() {

                if [[ $(which zsh) == "/data/data/com.termux/files/usr/bin/zsh" ]]; then

                    chsh -s zsh
                    stop_spinner $?

                else

                    cp "empty" > /dev/null 2>&1
                    stop_spinner $?

                fi

            }

            check

        }

    zsh

}

# ZSH Themes
owl4cethemes=(

    "rounded.zsh-theme"
    "ar-round.zsh-theme"
    "la-round.zsh-theme"

)

function owl4cezsh() {

    echo -e "\nâš™ï¸ Installing ZSH Theme"

    for owl4cetheme in "${owl4cethemes[@]}"; do

        start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ $owl4cetheme"
        sleep 2
        cp $DIR/.oh-my-zsh/custom/themes/$owl4cetheme $HOME/.oh-my-zsh/custom/themes/$owl4cetheme

        check() {

            if [[ -f $HOME/.oh-my-zsh/custom/themes/$owl4cetheme ]]; then

                stop_spinner $?

            else

                cp "empty" > /dev/null 2>&1
                stop_spinner $?

            fi

        }

        check

    done

}

# Dotfiles
vardotfiles=(

    ".zshrc"
    ".termux"
    ".config"
    ".color-toys"

)
function dotfiles() {

    echo -e "\nâš™ï¸ Installing dotfiles"

    for dotfile in "${vardotfiles[@]}"; do

        if [[ "$dotfile" == ".zshrc" ]]; then
            
            start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ $dotfile"
            sleep 2
            cp $DIR/$dotfile $HOME/$dotfile

            check() {

                if [[ -f $HOME/$dotfile ]]; then

                    stop_spinner $?

                else

                    cp "empty" > /dev/null 2>&1
                    stop_spinner $?
                    start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ $dotfile (retrying)"
                    sleep 2
                    cp $DIR/$dotfile $HOME/$dotfile
                    check

                fi

            }

            check

        elif [[ "$dotfile" == ".termux" ]]; then
        
            start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ $dotfile"

            sleep 2
            cp -R $DIR/$dotfile $HOME/$dotfile

            check() {

                if [[ -d $HOME/$dotifle ]]; then

                    termux-reload-settings
                    stop_spinner $?

                else

                    cp "empty" > /dev/null 2>&1
                    stop_spinner $?
                    start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ $dotfile (retrying)"
                    sleep 2
                    cp -R $DIR/$dotfile $HOME/$dotfile
                    check

                fi

            }

            check
        
        else

            start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ $dotfile"
            sleep 2
            cp -R $DIR/$dotfile $HOME/$dotfile

            check() {

                if [[ -d $HOME/$dotfile ]]; then

                    stop_spinner $?

                else

                    cp "empty" > /dev/null 2>&1
                    stop_spinner $?
                    start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ $dotfile (retrying)"
                    sleep 2
                    cp -R $DIR/$dotfile $HOME/$dotfile
                    check

                fi

            }

            check

        fi

    done

}

function neovimplug() {

    echo -e "\nâš™ï¸ Installing neovim plugins"

    start_spinner "â€â€â€â€â€â€ â€â€â€â€ â€ğŸ“¦ coc.vim & etc"
    sleep 2

    (
        set -e
        nvim --headless +PlugInstall +qall > /dev/null 2>&1
    )

    if [ $? -eq 0 ]; then

        stop_spinner $?

    else

        sleep 2
        cp "empty" > /dev/null 2>&1
        stop_spinner $?

    fi

}

function permission() {

    termux-setup-storage

}

function welcome() {

    if [[ -f $PREFIX/etc/motd ]]; then

        mv $PREFIX/etc/motd $HOME/motd.$(date +%Y.%m.%d-%H.%M.%S)

    fi

}

function finish() {

    echo -e "\nâ€â€â€â€â€â€ â€â€â€â€ âš ï¸ Message :"
    echo -e "      - ZSH not apply (Need restart)"
    echo -e "      - Termux Properties size (Need restart to fix the size)"
    echo -e ""
    echo -e "â€â€â€â€â€â€ â€â€â€â€ âš ï¸ Known Installation Bug :"

    echo -e "      - Colorscheme not automatic changed (Need run by manual)"
    echo -e "        with 'cp -R .termux ~/ && termux-reload-settings'\n"

}
